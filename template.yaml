AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  keyhole-finder

  Sample SAM Template for keyhole-finder
  
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 3

Resources:
  SubscriptionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: KeyholeSubscriptions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: date
          AttributeType: S
        - AttributeName: subscriber
          AttributeType: S
      KeySchema:
        - AttributeName: date
          KeyType: HASH
        - AttributeName: subscriber
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: subscriber-index
          KeySchema:
            - AttributeName: subscriber
              KeyType: HASH
          Projection:
            ProjectionType: KEYS_ONLY

  SubscriptionsTableRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: subscriptions-table-accessor
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'

  SubscriptionsTablePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: subscriptions-table-access
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:*
            Resource: !GetAtt SubscriptionsTable.Arn
      Roles:
        - Ref: SubscriptionsTableRole

  SMSReceiptTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: KeyholeFinder
      TopicName: KeyholeFinderInbound

  HelloSmsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: sms-hello/
      Handler: app.receiveSMS
      Runtime: nodejs14.x
      Architectures:
        - x86_64
      Events:
        SNS1:
          Type: SNS
          Properties:
            Topic: arn:aws:sns:us-east-1:501159871365:SMSBotTest

  ReceiveSMSFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: lambda-functions/
      Handler: listener.listen
      Runtime: nodejs14.x
      Architectures:
        - x86_64
      Events:
        SNS1:
          Type: SNS
          Properties:
            Topic:
              Ref: SMSReceiptTopic